<!-- Hilton Heat Today's Schedule Widget - Self-Contained HTML Element -->
<!-- Copy this entire block into your existing HTML page -->
<div id="hilton-heat-today-widget">
    <style>
        #hilton-heat-today-widget {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        #hilton-heat-today-widget .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #666;
            font-size: 16px;
            font-weight: 500;
        }
        
        #hilton-heat-today-widget .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .today-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .today-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .today-header .date {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* FullCalendar List View Styling */
        .fc-list-event {
            border-left: 4px solid #3498db !important;
        }
        
        .fc-list-event.all-teams { border-left-color: #4a90e2 !important; }
        .fc-list-event.bu8-u11 { border-left-color: #87ceeb !important; }
        .fc-list-event.gu8-u11 { border-left-color: #ffb6c1 !important; }
        .fc-list-event.group-a { border-left-color: #ffb366 !important; }
        .fc-list-event.group-b { border-left-color: #66b3ff !important; }
        .fc-list-event.group-c { border-left-color: #cc99ff !important; }
        .fc-list-event.group-d { border-left-color: #99ff99 !important; }
        .fc-list-event.group-e { border-left-color: #ff99cc !important; }
        .fc-list-event.group-f { border-left-color: #bed6a1 !important; }
        
        /* Make FullCalendar header text smaller */
        .fc-toolbar-title {
            font-size: 16px !important;
        }
        
        .fc-button {
            font-size: 12px !important;
        }
        
        /* Target all FullCalendar header elements */
        .fc .fc-toolbar-title {
            font-size: 16px !important;
        }
        
        .fc .fc-button {
            font-size: 12px !important;
            padding: 4px 8px !important;
        }
        
        .fc .fc-toolbar-chunk {
            font-size: 14px !important;
        }
        
        /* Target the date display specifically */
        .fc .fc-toolbar-title {
            font-size: 14px !important;
            font-weight: normal !important;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            #hilton-heat-today-widget {
                padding: 10px;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            
            .today-header h2 {
                font-size: 20px;
            }
            
            .today-header .date {
                font-size: 14px;
            }
        }
        
        /* Button hover effect */
        .schedule-link:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
    </style>

        <div id="calendar"></div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; display: flex; justify-content: center; align-items: center; gap: 20px;">
            <a href="https://hiltonheat.demosphere-secure.com/training/dome-practice-schedule" class="schedule-link" target="_parent" style="display: inline-block; background: #dc2626; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease; border: 2px solid #dc2626;">
                ðŸ“… View Full Schedule
            </a>
            
            <div id="loading" class="loading-spinner" style="display: flex; align-items: center;">
                <div class="spinner" style="width: 12px; height: 12px; border: 1px solid #f3f3f3; border-top: 1px solid #dc2626; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script>
        (function() {
            // ICS Calendar URLs from TeamSnap
            const calendarUrls = [
                'http://ical-cdn.teamsnap.com/team_schedule/b2096e06-e20f-4f4f-966b-967ac79af6d2.ics', // All Teams
                'http://ical-cdn.teamsnap.com/team_schedule/a724cc32-b034-4e03-82f0-82f629070766.ics', // BU8-U11
                'http://ical-cdn.teamsnap.com/team_schedule/821c820e-d1d2-40bf-ba5a-a59d5868bfe4.ics', // GU8-U11
                'http://ical-cdn.teamsnap.com/team_schedule/fe26fd70-41ea-4ada-882e-395c4977aaed.ics', // Group A
                'http://ical-cdn.teamsnap.com/team_schedule/b0c5df38-a03c-4179-9c24-521598a08f33.ics', // Group B
                'http://ical-cdn.teamsnap.com/team_schedule/8701149b-8ccf-4c7b-b392-19e6b3540918.ics', // Group C
                'http://ical-cdn.teamsnap.com/team_schedule/8e017eab-a8f6-43a2-b454-f66331d0c5b6.ics', // Group D
                'http://ical-cdn.teamsnap.com/team_schedule/f022318b-d44f-4222-ac27-3ba922eee507.ics', // Group E
                'http://ical-cdn.teamsnap.com/team_schedule/6c09f5c2-a47f-475e-b194-3ebc79d235ad.ics'  // Group F
            ];

            let allEvents = [];
            let selectedDate = new Date();
            selectedDate.setHours(0, 0, 0, 0); // Start of selected date

            // Initialize widget when DOM is ready
            function initializeWidget() {
                // Set initial date
                updateDateDisplay();

                // Initialize FullCalendar with List view
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) return;

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'listDay',
                    headerToolbar: {
                        left: 'prev,next',
                        center: 'title',
                        right: 'today'
                    },
                    events: [],
                    eventClick: function(info) {
                        alert('Event: ' + info.event.title + '\nStart: ' + info.event.start.toLocaleString());
                    },
                    datesSet: function(info) {
                        // Update selected date when user navigates
                        selectedDate = new Date(info.start);
                        selectedDate.setHours(0, 0, 0, 0);
                        updateDateDisplay();
                        loadEventsForDate(calendar);
                    }
                });
                calendar.render();

                // Load all calendars
                loadAllCalendars(calendar);
            }

            async function loadAllCalendars(calendar) {
                for (let i = 0; i < calendarUrls.length; i++) {
                    await loadCalendar(calendarUrls[i], i + 1);
                }

                console.log('All calendars loaded. Total events:', allEvents.length);
                if (allEvents.length > 0) {
                    console.log('Sample events:', allEvents.slice(0, 3));
                }

                // Hide loading spinner
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';
                
                // Show content
                const contentEl = document.getElementById('today-content');
                if (contentEl) contentEl.style.display = 'block';
                
                // Load events for current date
                loadEventsForDate(calendar);
            }
            
            function updateDateDisplay() {
                const dateElement = document.getElementById('today-date');
                if (dateElement) {
                    dateElement.textContent = selectedDate.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                }
            }
            
            function loadEventsForDate(calendar) {
                // Filter events for selected date
                const dateEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    eventDate.setHours(0, 0, 0, 0);
                    return eventDate.getTime() === selectedDate.getTime();
                });

                // Debug logging
                console.log('Selected date:', selectedDate);
                console.log('Total events loaded:', allEvents.length);
                console.log('Events for selected date:', dateEvents.length);
                if (dateEvents.length > 0) {
                    console.log('Sample event:', dateEvents[0]);
                }

                // Add events to FullCalendar
                calendar.removeAllEvents();
                calendar.addEventSource(dateEvents);
            }

            async function loadCalendar(url, calendarIndex) {
                // Add small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, calendarIndex * 200));
                
                // Use the working CORS proxy
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/calendar,text/plain,*/*'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const icsContent = await response.text();
                    
                    const events = parseICS(icsContent, calendarIndex);
                    allEvents = allEvents.concat(events);
                    console.log(`Calendar ${calendarIndex} loaded ${events.length} events`);
                    
                } catch (error) {
                    console.log(`Calendar ${calendarIndex} failed to load:`, error.message);
                }
            }

            function parseICS(icsContent, calendarIndex) {
                const events = [];
                const lines = icsContent.split('\n');
                
                let currentEvent = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === 'BEGIN:VEVENT') {
                        currentEvent = {};
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.summary) {
                            // Determine group color based on event title
                            let color = '#3498db'; // default blue
                            let className = '';
                            if (currentEvent.summary.includes('All Teams')) { color = '#4a90e2'; className = 'all-teams'; }
                            else if (currentEvent.summary.includes('BU8-U11')) { color = '#87ceeb'; className = 'bu8-u11'; }
                            else if (currentEvent.summary.includes('GU8-U11')) { color = '#ffb6c1'; className = 'gu8-u11'; }
                            else if (currentEvent.summary.includes('Group A')) { color = '#ffb366'; className = 'group-a'; }
                            else if (currentEvent.summary.includes('Group B')) { color = '#66b3ff'; className = 'group-b'; }
                            else if (currentEvent.summary.includes('Group C')) { color = '#cc99ff'; className = 'group-c'; }
                            else if (currentEvent.summary.includes('Group D')) { color = '#99ff99'; className = 'group-d'; }
                            else if (currentEvent.summary.includes('Group E')) { color = '#ff99cc'; className = 'group-e'; }
                            else if (currentEvent.summary.includes('Group F')) { color = '#bed6a1'; className = 'group-f'; }
                            
                            const event = {
                                title: currentEvent.summary,
                                start: currentEvent.dtstart,
                                end: currentEvent.dtend,
                                allDay: false,
                                color: color,
                                classNames: [className]
                            };
                            
                            // Only add events with valid dates
                            if (event.start && event.start.toString() !== 'Invalid Date') {
                                events.push(event);
                                // Debug: log events for Oct 19
                                if (event.start.getMonth() === 9 && event.start.getDate() === 19) {
                                    console.log('Oct 19 event found:', event.title, event.start);
                                }
                            }
                        }
                        currentEvent = null;
                    } else if (currentEvent && line.startsWith('DTSTART')) {
                        const dateStr = line.substring(line.indexOf(':') + 1);
                        currentEvent.dtstart = parseICSDate(dateStr);
                    } else if (currentEvent && line.startsWith('DTEND')) {
                        const dateStr = line.substring(line.indexOf(':') + 1);
                        currentEvent.dtend = parseICSDate(dateStr);
                    } else if (currentEvent && line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8);
                    }
                }
                
                return events;
            }

            function parseICSDate(dateStr) {
                try {
                    // Handle different ICS date formats
                    if (dateStr.includes('T')) {
                        // Format: 20251023T170000 or 20251023T170000Z
                        const cleanDate = dateStr.replace('Z', '');
                        if (cleanDate.length === 15) {
                            // YYYYMMDDTHHMMSS format
                            const year = cleanDate.substring(0, 4);
                            const month = cleanDate.substring(4, 6);
                            const day = cleanDate.substring(6, 8);
                            const hour = cleanDate.substring(9, 11);
                            const minute = cleanDate.substring(11, 13);
                            const second = cleanDate.substring(13, 15);
                            
                            return new Date(year, month - 1, day, hour, minute, second);
                        }
                    } else if (dateStr.length === 8) {
                        // Format: 20251023 (date only)
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        
                        return new Date(year, month - 1, day);
                    }
                    
                    // Fallback to standard Date parsing
                    return new Date(dateStr);
                } catch (error) {
                    return null;
                }
            }


            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWidget);
            } else {
                initializeWidget();
            }
        })();
    </script>
</div>
